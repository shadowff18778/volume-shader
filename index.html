<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="user-scalable=no,width=device-width,initial-scale=1.0">
<title>volumeshader_bm_ultra_interactive</title>
<style>
body{margin:0;overflow:hidden;background:#131115}
#main{position:fixed;left:0;top:0;transform-origin:0 0}
#c1{display:block;background:#fbf7fe}
</style>
</head>

<body>
<div id="main"><canvas id="c1"></canvas></div>

<script>
/* ================== STATE ================== */
let gl,canvas,cx,cy;
let ang1=2.8,ang2=0.4,len=1.6;
let cenx=0,ceny=0,cenz=0;

/* interaction */
let mx=0,my=0,mx1=0,my1=0;
let ml=0,mr=0,lasttimen=0;

/* ================== KERNEL ================== */
let KERNEL=`float kernal(vec3 v){
vec3 a=v;float b,c,d;
for(int i=0;i<4;i++){
b=dot(a,a);
c=atan(a.y,a.x)*8.0;
d=acos(a.z/sqrt(b))*8.0;
b=pow(b,4.0);
a=vec3(b*sin(d)*cos(c),b*sin(d)*sin(c),b*cos(d))+v;
if(b>6.0)break;
}
return 4.0-dot(a,a);
}`;

/* ================== SHADERS ================== */
const VS=`
precision mediump float;
attribute vec4 position;
uniform vec3 right,up,forward;
uniform float x,y;
varying vec3 dir,ld;
void main(){
gl_Position=position;
ld=vec3(position.x*x,position.y*y,-1.0);
dir=forward+right*ld.x+up*ld.y;
}`;

const FS=`
precision mediump float;
#define SOLVER 4
float kernal(vec3 v);
uniform vec3 right,up,forward,origin;
uniform float len;
varying vec3 dir,ld;
void main(){
vec3 col=vec3(0.0);
float step=0.0036;
float v1=kernal(origin);
float r=0.0;
bool hit=false;

for(int k=1;k<420;k++){
r=float(k)*step*len;
vec3 p=origin+dir*r;
if(dot(p,p)>32.0)break;
float v=kernal(p);
if(v>0.0 && v1<0.0){
float a=r-step*len;
float b=r;
for(int i=0;i<SOLVER;i++){
float m=0.5*(a+b);
if(kernal(origin+dir*m)>0.0)b=m;else a=m;
}
r=0.5*(a+b);
hit=true;
break;
}
v1=v;
}

if(hit){
vec3 p=origin+dir*r;
float e=r*0.0004;
vec3 n=vec3(
kernal(p-right*e)-kernal(p+right*e),
kernal(p-up*e)-kernal(p+up*e),
kernal(p+forward*e)-kernal(p-forward*e)
);
n=normalize(n);
vec3 v=normalize(ld);
vec3 refl=v-2.0*dot(v,n)*n;
float l=max(0.0,dot(refl,vec3(0.3,0.9,0.3)));
float base=0.28+0.5*l*l*l+0.22*dot(n,vec3(0.3,0.9,0.3));
float rr=dot(p,p);
col=vec3(
sin(rr*8.0)*0.5+0.5,
sin(rr*8.0+2.1)*0.5+0.5,
sin(rr*8.0-2.1)*0.5+0.5
)*base;
}
gl_FragColor=vec4(col,1.0);
}`;

/* ================== RESIZE ================== */
function resize(){
cx=cy=Math.min(innerWidth,innerHeight);
const dpr=Math.min(devicePixelRatio,1.15);
canvas.width=1024*dpr;
canvas.height=1024*dpr;
gl.viewport(0,0,canvas.width,canvas.height);
document.getElementById("main").style.transform=
`scale(${cx/1024},${cy/1024})`;
}

/* ================== INIT ================== */
function init(){
canvas=document.getElementById("c1");
gl=canvas.getContext("webgl",{antialias:false,depth:false});
resize();onresize=resize;

/* buffer */
const buf=gl.createBuffer();
gl.bindBuffer(gl.ARRAY_BUFFER,buf);
gl.bufferData(gl.ARRAY_BUFFER,new Float32Array([
-1,-1,0, 1,-1,0, 1,1,0,
-1,-1,0, 1,1,0, -1,1,0
]),gl.STATIC_DRAW);

/* shaders */
const vs=gl.createShader(gl.VERTEX_SHADER);
const fs=gl.createShader(gl.FRAGMENT_SHADER);
gl.shaderSource(vs,VS);
gl.shaderSource(fs,FS+KERNEL);
gl.compileShader(vs);
gl.compileShader(fs);

const p=gl.createProgram();
gl.attachShader(p,vs);
gl.attachShader(p,fs);
gl.linkProgram(p);
gl.useProgram(p);

/* attributes / uniforms */
const pos=gl.getAttribLocation(p,"position");
gl.enableVertexAttribArray(pos);
gl.vertexAttribPointer(pos,3,gl.FLOAT,false,0,0);

p.right=gl.getUniformLocation(p,"right");
p.up=gl.getUniformLocation(p,"up");
p.forward=gl.getUniformLocation(p,"forward");
p.origin=gl.getUniformLocation(p,"origin");
p.x=gl.getUniformLocation(p,"x");
p.y=gl.getUniformLocation(p,"y");
p.len=gl.getUniformLocation(p,"len");

/* render loop */
function draw(){
const inv=2/(cx+cy);
gl.uniform1f(p.x,cx*inv);
gl.uniform1f(p.y,cy*inv);
gl.uniform1f(p.len,len);
gl.uniform3f(p.origin,
len*Math.cos(ang1)*Math.cos(ang2)+cenx,
len*Math.sin(ang2)+ceny,
len*Math.sin(ang1)*Math.cos(ang2)+cenz
);
gl.uniform3f(p.right,Math.sin(ang1),0,-Math.cos(ang1));
gl.uniform3f(p.up,-Math.sin(ang2)*Math.cos(ang1),Math.cos(ang2),-Math.sin(ang2)*Math.sin(ang1));
gl.uniform3f(p.forward,-Math.cos(ang1)*Math.cos(ang2),-Math.sin(ang2),-Math.sin(ang1)*Math.cos(ang2));
gl.drawArrays(gl.TRIANGLES,0,6);
}

function loop(){
ang1+=0.0025;
draw();
requestAnimationFrame(loop);
}
loop();
}

/* ================== INTERACTIONS ================== */
document.addEventListener("mousedown",e=>{
if(e.button===0)ml=1;
if(e.button===2)mr=1;
mx=e.clientX;my=e.clientY;
});
document.addEventListener("mouseup",e=>{
if(e.button===0)ml=0;
if(e.button===2)mr=0;
});
document.addEventListener("mousemove",e=>{
if(ml){
ang1+=(e.clientX-mx)*0.002;
ang2+=(e.clientY-my)*0.002;
}
if(mr){
const l=len*4/(cx+cy);
cenx+=l*(-(e.clientX-mx)*Math.sin(ang1)-(e.clientY-my)*Math.sin(ang2)*Math.cos(ang1));
ceny+=l*((e.clientY-my)*Math.cos(ang2));
cenz+=l*((e.clientX-mx)*Math.cos(ang1)-(e.clientY-my)*Math.sin(ang2)*Math.sin(ang1));
}
mx=e.clientX;my=e.clientY;
});
document.addEventListener("wheel",e=>{
e.preventDefault();
len*=Math.exp(-0.001*e.deltaY);
},{passive:false});

/* touch */
document.addEventListener("touchstart",e=>{
const t=e.touches;
if(t.length===1){
mx=t[0].clientX;my=t[0].clientY;
}else if(t.length===2){
mx=t[0].clientX;my=t[0].clientY;
mx1=t[1].clientX;my1=t[1].clientY;
}
lasttimen=t.length;
},{passive:false});

document.addEventListener("touchmove",e=>{
e.preventDefault();
const t=e.touches;
if(t.length===1 && lasttimen===1){
ang1+=(t[0].clientX-mx)*0.002;
ang2+=(t[0].clientY-my)*0.002;
mx=t[0].clientX;my=t[0].clientY;
}
else if(t.length===2){
const l=len*2/(cx+cy);
cenx+=l*(-(t[0].clientX+t[1].clientX-mx-mx1)*Math.sin(ang1)
-(t[0].clientY+t[1].clientY-my-my1)*Math.sin(ang2)*Math.cos(ang1));
ceny+=l*((t[0].clientY+t[1].clientY-my-my1)*Math.cos(ang2));
cenz+=l*((t[0].clientX+t[1].clientX-mx-mx1)*Math.cos(ang1)
-(t[0].clientY+t[1].clientY-my-my1)*Math.sin(ang2)*Math.sin(ang1));
const d0=Math.hypot(mx-mx1,my-my1)+1;
mx=t[0].clientX;my=t[0].clientY;
mx1=t[1].clientX;my1=t[1].clientY;
const d1=Math.hypot(mx-mx1,my-my1)+1;
len*=d0/d1;
}
lasttimen=t.length;
},{passive:false});

document.oncontextmenu=e=>e.preventDefault();

onload=init;
</script>
</body>
</html>
